# Spring AI Observability with Actuator

This project demonstrates Spring AI Observability using Spring Boot Actuator metrics and Promethous/Grafana dashboard for monitoring and visualization.

---

## Getting Started

1. Add Spring Boot Actuator dependency in your project.
2. Configure Actuator to expose the `metrics` endpoint.
3. Start the Spring Boot application.
4. Access all metrics at:

http://localhost:8080/actuator/metrics

5. Trigger AI operations using Postman, curl, or browser to generate metrics data.

---

## AI Observability Metrics
Spring Boot Actuator provides application metrics, and Spring AI automatically publishes AI-related metrics. Here are some key metrics to monitor:

1. Metric Name: gen_ai.client.token.usage  
   URL: http://localhost:8080/actuator/metrics/gen_ai.client.token.usage  
   Description: Returns total tokens consumed (input + output) across all AI calls since application startup.

2. Metric Name: gen_ai.client.token.usage (Output Tokens)  
   URL: http://localhost:8080/actuator/metrics/gen_ai.client.token.usage?tag=gen_ai.token.type:output  
   Description: Returns only the output tokens generated by the LLM.

3. Metric Name: gen_ai.client.token.usage (Input Tokens)  
   URL: http://localhost:8080/actuator/metrics/gen_ai.client.token.usage?tag=gen_ai.token.type:input  
   Description: Returns only the input tokens sent to the LLM.

4. Metric Name: gen_ai.client.operation  
   URL: http://localhost:8080/actuator/metrics/gen_ai.client.operation  
   Description: Returns the total number of AI client invocations to monitor overall AI request volume.

5. Metric Name: gen_ai.client.operation.active  
   URL: http://localhost:8080/actuator/metrics/gen_ai.client.operation.active  
   Description: Returns the current number of active (in-progress) AI operations to monitor concurrency and load.

6. Metric Name: spring.ai.advisor  
   URL: http://localhost:8080/actuator/metrics/spring.ai.advisor  
   Description: Returns how many times Spring AI Advisors have been invoked during AI operations.

7. Metric Name: spring.ai.tool  
   URL: http://localhost:8080/actuator/metrics/spring.ai.tool  
   Description: Returns the total number of AI tool (function call) invocations.

8. Metric Name: spring.ai.tool.active  
   URL: http://localhost:8080/actuator/metrics/spring.ai.tool.active  
   Description: Returns the number of currently active AI tool executions.

9. Metric Name: spring.ai.chat.client  
   URL: http://localhost:8080/actuator/metrics/spring.ai.chat.client  
   Description: Returns metrics related to chat client operations such as invocation count and duration.

10. Metric Name: spring.ai.chat.client.active  
    URL: http://localhost:8080/actuator/metrics/spring.ai.chat.client.active  
    Description: Returns the number of active chat client operations currently in progress.

## Reference

For a complete and updated list of Spring AI observability metrics, refer to:

https://docs.spring.io/spring-ai/reference/observability/index.html

---
## Why Actuator Alone Is Not Enough?

Spring Boot Actuator is designed to expose application metrics and health information,provides only ut it does not have built-in support for
monitoring and alerting capabilities. 

So, we need to integrate it with a monitoring system like Prometheus which is an open-source monitoring and alerting toolkit that 
scrapes metrics from actuator endpoints, stores them in a time-series database, and provides a query language for analysis.

But Prometheus does not understand Actuator's metrics format. So use a metrics instrumentation facade like Micrometer to format and expose the metrics in a Prometheus-compatible format.

### Metrics Flow

Spring AI → Micrometer → Actuator (`/actuator/prometheus`) → Prometheus

### Micrometer Integration Steps
1. Add Micrometer and Prometheus dependencies to your Spring Boot project.
   - `io.micrometer:micrometer-registry-prometheus`
2. Start your Spring Boot application and ensure the `http://localhost:8080/actuator/prometheus` endpoint is accessible

### Prometheus Configuration using docker-compose.yml
- volumes:- is used to mount the `prometheus-config.yml` file from your local directory to the Prometheus container. 
- `prometheus-config.yml`:- is the configuration file for Prometheus where you specify the scrape targets (your Spring Boot application).
- `/etc/prometheus/prometheus.yml`:- is the default location where Prometheus looks for its configuration file inside the container. 
- ports:- is used to map the Prometheus server's port (9090) to the host machine, allowing you to access the Prometheus web interface at `http://localhost:9090`.
- networks:- application name defined in application.yml, prometheus will use to discover the actuator endpoints.
- bridge:- Its is default network driver for Docker containers. It creates an isolated network for the containers to communicate with each other. In this case, it allows the Prometheus container to communicate with the Spring Boot application container.

### prometheus-config.yml
- `scrape_configs`:- is a section in the Prometheus configuration file where you define the targets that Prometheus should scrape for metrics.
- `job_name`:- is a label that identifies the scrape job. It can be any name you choose, and it helps you organize and differentiate between different scrape jobs in Prometheus.
- `static_configs.targets`:- is a list of targets that Prometheus should scrape for metrics. In this case, it specifies the URL of the Actuator endpoint where the metrics are exposed. 
- host.docker.internal:- is a special DNS name that allows Docker containers to access services running on the host machine. In this case, it allows the Prometheus container to access the Spring 
  Boot application running on the host machine at port 8080.

### Grafana Configuration using docker-compose.yml
- volumes:-  storage for dashboard data to keep it persistent even if application restarts.
- volumes.grafana-storage:- create empty storage for grafana data.
- when application starts , access grafana dashboard at `http://localhost:3000` 
- login with default credentials (admin/admin) and it ask to update creds but if want to skip then click on skip and go to home page of grafana dashboard.

### Adding Prometheus as Data Source in Grafana
- Click on "Add your first data source" or navigate to Connections > Data Sources > Add Data Source.
- Select "Prometheus" from the list of available data sources.
- In the Prometheus Server URL field enter `http://prometheus:9090` (Dont enter `localhost:9090` because in docker , the service name we defined in compose.yaml file as prometheus so grafana container can find it by its name).
- Then click on "Save & Test" to verify the connection to Prometheus. You should see a message confirming that the data source is working.

### Add Dashboard in Grafana
- Click on Dashboards > Add Visualization
- Select data source as Prometheus.
- Select a metric to visualize (e.g., `gen_ai.client.token.usage`).
- Select Label filters from dropdown to filter the metrics based on specific tags (e.g., `gen_ai.token.type`).
- And then select filter value (e.g., `input` or `output`) to visualize only the input or output tokens.
- Click on "Run Query" to see the graph of the selected metric.
- After filling all the details, click on "Save Dashboard" to save your dashboard for future use.
- To view the dashboard, navigate to Dashboards > View saved dashboard as Panel and Manage and view.
- 
#### Add/Develop more panels to the same dashboard to visualize other metrics
- Dashboards > Select your dashboard > Click on Add dropdown > select Visualization
- Repeat step to add metrics and visualize them in the same dashboard.

### View Grafana Storage in Docker
-  Click on Volumes
-  Find the volume named `grafana-storage` and click on it to view its details.
-  Even if grafana container is stopped or removed, the data in `grafana-storage` volume will persist, allowing you to retain your dashboards and configurations when you restart the container.
